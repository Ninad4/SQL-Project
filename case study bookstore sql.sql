show databases;
create database bookstore;
use bookstore;

create table books
(book_id int primary key,
title varchar(20),
author varchar(20),
publication_year year,
price decimal(7,2),
avail_quantity int);

create table customer
(customer_id int primary key,
firstname varchar(20),
lastname varchar(20),
email varchar(20),
registration_date date);

create table orders
(order_id int primary key,
customer_id int ,foreign key(customer_id) references customer(customer_id),
order_date date,
total_amt decimal(7,2));

create table order_details
(order_id int,foreign key(order_id) references orders(order_id),
book_id int ,foreign key(book_id) references books(book_id),
quantity int,
subtotal decimal(7,2));

show tables;

describe books;
select * from books;
insert into books values
(1,"A Light in the Attic","Abraham Stackhouse",2008,500,10),
(2,"Tipping the Velvet","Arthur McCrumb",2008,200,9),
(3,"Soumission","Bernard",2010,850,20),
(4,"Sharp Objects","Bravig",2011,600,14),
(5,"Sapiens","Charles",2019,400,22),
(6,"The Requiem Red","Darryl",2001,500,5),
(7,"Bright Lines","Elmer",2020,750,8),
(8,"The Coming Woman","Grace",2015,900,50),
(9,"The Boys in the Boat","Hamlin",2016,610,22),
(10,"The Black Maria","Jill",2017,450,6),
(11,"Starving Hearts","John W.",2020,750,2),
(12,"Meditations","Jonathan",2016,350,5),
(13,"Set Me Free","Charles",2016,650,25),
(14,"Alice in Wonderland","Elmer",2020,400,7),
(15,"Bounty","Bernard",2017,530,13);
update books set publication_year=2022 where book_id=13;

describe customer;
insert into customer values
(100, 'Steven', 'King', 'SKING','2009-06-17'),
(101, 'Neena', 'Kochhar', 'NKOCHHAR','2019-05-2'),
(102, 'Lex', 'De Haan', 'LDEHAAN','2010-05-3'),
(103, 'Alexander', 'Hunold', 'AHUNOLD','2008-04-22'),
(104, 'Bruce', 'Ernst', 'BERNST','2016-06-30'),
(105, 'David', 'Austin', 'DAUSTIN','2020-09-6'),
(106, 'Valli', 'Pataballa', 'VPATABAL','2015-01-19'),
(107, 'Diana', 'Lorentz', 'DLORENTZ','2015-02-11'),
(108, 'Nancy', 'Greenberg', 'NGREENBE','2016-06-30'),
(109, 'Daniel', 'Faviet', 'DFAVIET','2012-08-30'),
(110, 'John', 'Chen', 'JCHEN','2011-03-19'),
(111, 'Ismael', 'Sciarra', 'ISCIARRA','2011-09-15'),
(112, 'Jose Manuel', 'Urman', 'JMURMAN','2020-08-05'),
(113, 'Luis', 'Popp', 'LPOPP','2018-02-03'),
(114, 'Den', 'Raphaely', 'DRAPHEAL','2012-07-22'),
(115, 'Alexander', 'Khoo', 'AKHOO','2017-04-26');

select * from customer;
describe orders;
insert into orders values
(201,102,'2019-04-26',1500),
(202,103,'2012-05-15',2000),
(203,101,'2017-06-6',2500),
(204,106,'2010-05-20',1500),
(205,105,'2021-04-26',1600),
(206,101,'2015-05-11',1200),
(207,104,'2011-02-2',2220),
(208,100,'2012-09-16',1500),
(209,111,'2014-06-3',2400),
(210,112,'2013-04-29',1550),
(211,115,'2015-07-21',1400),
(212,113,'2016-08-9',1350),
(213,109,'2017-01-30',2550),
(214,105,'2010-10-25',3500),
(215,115,'2020-11-12',4500);

select * from orders;
select * from books;
describe order_details;
insert into order_details values
(202,1,2,2000),
(204,2,2,1500),
(201,3,3,1500),
(203,13,3,2500),
(205,4,2,1600),
(206,5,2,1200),
(207,6,4,1600),
(210,2,4,2500),
(208,15,4,2750),
(215,14,4,1500),
(214,12,4,1200),
(213,11,4,1900),
(209,5,4,1800),
(208,10,3,1500);

select * from orders;
set SQL_SAFE_UPDATES=0;


# 1) Retrieve a list of books (book title and author) published in the year 2022.
select book_id,title,author from books where publication_year="2022";

# 2) Calculate the total revenue generated by the bookstore in the year 2022.
select order_date,sum(total_amt) from orders where order_date=2022;

# 3) Find the top 5 bestselling books (based on the total quantity sold) in descending order
select book_id,sum(quantity) from order_details group by book_id order by sum(quantity) desc;

# 4)Determine the customer who made the highest total purchase amount and the total amount they spent.
select customer_id,sum(total_amt) from orders group by customer_id order by sum(total_amt) desc;

# 5) Calculate the average price of books published before the year 2010.
describe customer;
select book_id,publication_year,avg(price) from books group by publication_year having publication_year<2010;

# 6) Identify the customer(s) who registered in 2023.
select * from customer;
select customer_id,registration_date from customer where registration_date=2023;  

# 7) Calculate the total number of orders placed in the database.
select count(order_id) from order_details;

# 8) Find the book(s) with the lowest available quantity in stock.
select book_id,title,min(avail_quantity) from books;
select book_id,title,max(avail_quantity) from books group by book_id order by min(avail_quantity);

# 9) Calculate the total revenue for each year from 2020 to 2022.
describe orders;
select order_date,sum(total_amt) from orders group by order_date having order_date between 2020 and 2022;

# 10) Determine the customer(s) with the most orders placed.
describe order_details;
select customer_id,order_id,sum(quantity) from orders join order_details using (order_id) group by customer_id having sum(quantity) 
order by sum(quantity) desc;